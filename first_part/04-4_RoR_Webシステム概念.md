## 4.4 Ruby on Rails：Webシステム概念

### 4.4.1 インターネットの概要

インターネットとは、TCP/IPなどのプロトコルを利用して、コンピュータや、スマートフォン等ネットワーク機能を内蔵した電子機器で構成されるネットワークです。

そのネットワーク上で、電子メールでのテキストの送受信、スマートフォンで撮影したデジタル画像の送受信、WWW、SNSでの情報交換、クラウドサービスの利用等ができます。

機器の接続には、有線と無線(WiFi等)があり、一般的にインターネットに接続している機器は、異なるIPアドレスを持ち、自分と相手を特定して通信を行います。

インターネットは、プライベートのネットワークではありません。大勢の人の努力の結果、インターネットに接続することで、地球の裏側にあるインターネットに接続されている機器やサービスとも接続をすることができます。つまり、インターネットはひとかたまりのネットワーク(The Internet)です。

インターネット上で提供されているサービスには、自分を証明するアカウントを持たなくても利用できるサービスと、アカウントが必要なサービスがあります。

どちらの場合でも、サービスを提供する側はセキュリティを考慮する必要があります。

セキュリティを考慮しないと、たとえば、だれでも利用できるサービスの場合は、提供している文字や画像、動画、プログラム等を提供者の意図と異なるものに差し替えられる等が考えられます。また、アカウントが必要なサービスの場合は、アカウント名やパスワードを盗まれて、秘密であるはずの情報が第三者に閲覧、取得されてしまうこと等が考えられます。ですので、インターネットに接続するサービスでは、提供するコンテンツへのアクセス権や、暗号化、2段階認証等の技術を利用してセキュリティを十分考慮する必要があります。

上で紹介しているプロトコルとは、コンピューターやデバイス同士が情報をやり取りするための取り決めや手順のセットで「ルール」のようなものです。

昔は、このようなルールブックがなかったため独自にルールを作って通信していました。  
そのため、初期のコンピュータやネットワークシステムでは、同じメーカーの機器同士でのやり取りが一般的でした。このような状況は、特に大規模なシステムやネットワークにおいて、システムの拡張や新たな機能の導入を困難にしました。

しかし、プロトコルの標準化が進み、様々なメーカー間での相互運用性が高まるにつれて、異なるメーカー間での通信も可能になりました。特にインターネットの普及と共に、TCP/IPなどの標準プロトコルが広く受け入れられ、メーカー間の通信の壁が取り払われました。

通信には様々な種類のプロトコルがありますが、今回はその中でも代表的なものとして、TCP/IPについて挙げていきます。  

```
TCP/IPとは？
    Transmission Control Protocol/Internet Protocolの略称です。
    TCP/IPは、インターネットやローカルネットワークなどで情報を送受信するための基本的なルールや手順のセットです。
    TCPとIPは別物ですので、それぞれ説明していきます。

    TCP：
        ・TCPは、データの送受信を管理するプロトコルです。
        ・データをパケットと呼ばれる小さな塊に分割し、それらを送信します。
        ・受信側でパケットが正しく受信されたことを確認し、必要に応じて再送信を行います。
        ・データの送信順序や欠落したパケットの処理を管理し、データが正しく届くことを保証します。
        ・ウェブページのような大きなデータやファイルを安全に送信するのに適しています。
    IP：
        ・IPは、データを送受信するためのアドレスを管理するプロトコルです。
        ・データを送る際に、送信元と送信先のアドレスを付加して送信します。
        ・データは複数のネットワークを経由して送信されることがありますが、IPアドレスによって正しい宛先にデータを届けます。
        ・データの正確な送信を保証するのではなく、データの届く順番や欠けてしまったパケットの処理はTCPに任せます。
    
    TCP/IPの動作の流れ：

    1. データの分割：
        ・データは、TCPによって小さな塊（パケット）に分割される
    2. パケットの送信：
        ・分割されたパケットは、IPによって送信先のアドレスとともに送信される
    3. データの受信:
        ・受信側では、IPによって正しい宛先にパケットが届くように受け取る
        ・TCPによって、パケットが正しく受信されたかを確認し、必要に応じて再送信を行う

    イメージすると「ある書類が必要なので持ってきてほしい」と相手に頼みます。
    しかし、元々持っていた書類は大事なもので、大きな書類だったため封筒に入れることができませんでした。
    そのため、その書類をコピーし、分割して相手が送ってきます。
    そして、正確な住所を伝えているので、各部分のコピーが正確に届きます。
    分割されたコピーを受け取り、正しい順序で復元することで、必要な書類を手に入れることができます。
    もしコピーの一部が破れたり燃えたりしても、元の書類から作り直すことが容易です。

    TCP/IPは、インターネットだけでなく、ローカルネットワーク（自宅やオフィス内のネットワーク）でも広く使用されています。
    これにより、異なるデバイス間でデータを送受信する際に一貫した方法で通信することができます。
```

TCP/IPプロトコルは、4つの階層構造を持っており、それぞれの階層が異なる役割を担っています。

| 層 | 名称 | 内容 | 例 |
|:--|:--|:--|:--|
| 4層 | アプリケーション層 | ユーザーが直接利用するアプリケーションとやり取りするための層 | HTTP、SMTP、FTP |
|  |  | ウェブブラウザ、メールクライアント、ファイル転送プログラムなどがここで動作 |  |
| 3層 | トランスポート層 | アプリケーション間のデータの転送を管理 |TCP、UDP |
|  |  | データの送信と受信を制御し、エラー検出や再送などの機能を提供 |  |
| 2層 | インターネット層 | ネットワーク上でのデータのルーティング(経路の決定)を担当 | IP |
|  |  | データを送信する際に、最適な経路を見つけて宛先に届ける役割を果たす |  |
| 1層 | ネットワークアクセス層 | 物理的なネットワークにアクセスするための方法を提供 | イーサネット、Wi-Fi、PPP |
|  |  | データを物理的なメディア(イーサネット、Wi-Fi、光ファイバーなど)を介して送受信 |  |

IPアドレスは、TCP/IPのIPの部分でインターネット上のコンピューターやデバイスを識別するための一意の番号です。IPアドレスは、通常、4つの数字の組み合わせで表されます(例：192.168.0.1)。  
簡単に言うと家やオフィスの住所のようなものだと考えるとわかりやすいです。  

しかし、私たちが普段目にしているのは、<https://www.google.com/>といったものでウェブサイトにアクセスしています。このように住所に名前を付けることを「ドメイン」と呼びます。  
試しにアドレスバーに`172.217.161.3`と入力してみてください。同様にGoogleが表示されるはずです。

私たちはウェブブラウザなどのアプリケーションを使う際に、このドメイン名を使用してウェブサイトにアクセスしますが、実際にはそのウェブサイトのIPアドレスに接続しています。

#### リクエストとレスポンス

普段私たちはウェブページを閲覧するときにURLを入力するか、リンクをクリックしてページが表示されます。これらにはクライアント側(閲覧者)から送信されたリクエストをサーバーがレスポンスとして返す一連の流れによって成立しています。

では、実際にどのような流れでリクエストとレスポンスが行われているのか見ていきましょう。

1. ページの閲覧プロセス
    1. URLの入力またはリンクのクリック：
        - ユーザーがウェブブラウザのアドレスバーにURLを入力するか、あるいはリンクをクリックします。例えば、Googleのウェブページにアクセスしたい場合、ブラウザに https://www.google.com と入力します。
    2. HTTPリクエストの生成：
        - ブラウザは、入力されたURLに基づいてHTTPリクエストを生成します。Googleの場合、GETメソッドで/（ルート）に対するリクエストを生成します。
        ```html
        GET / HTTP/1.1
        Host: www.google.com
        ```
        - GET：リクエストのメソッドを指定しています。GETメソッドは、リソースの取得を要求します。つまり、ウェブページや画像、ファイルなどをサーバーから取得します。  
        - /：リクエストされているリソースのパスを示しています。この場合、ルートディレクトリ（通常はウェブサイトのホームページ）を要求しています。  
        - HTTP/1.1：使用しているHTTPのバージョンを示しています。HTTP/1.1は、現在のインターネット上で広く使用されているバージョンです。  

        「GET / HTTP/1.1」は、HTTPリクエストがルートディレクトリ（通常はウェブサイトのホームページ）を取得することを要求していることを示しています。
    3. リクエストの送信：
        - ブラウザは、生成したHTTPリクエストをウェブサーバーに送信します。
    4. サーバーでのリクエストの処理：
        - ウェブサーバーは、受け取ったリクエストを処理します。ルートに対するリクエストの場合、ホームページに対するレスポンスが生成されます。
    5. HTTPレスポンスの生成：
        - サーバーは、ホームページに対するHTTPレスポンスを生成します。
        ```html
        HTTP/1.1 200 OK
        Content-Type: text/html; charset=UTF-8

        <!DOCTYPE html>
        <html>
        <head>
            <title>title</title>
        </head>
        <body>
            <h1>Hello, World!</h1>
            <!-- 他のコンテンツ（画像、スクリプト、リンクなど） -->
        </body>
        </html>
        ```
        - HTTP/1.1 200 OK：サーバーからのレスポンスの状態を示しています。200は「成功」を示し、OKはその詳細を表しています。つまり、リクエストが正常に処理されたことを示しています。
        - Content-Type: text/html; charset=UTF-8：レスポンスの本文がHTML形式であり、文字エンコーディングはUTF-8であることを示しています。
        - HTML文書：ブラウザが表示するウェブページの内容を定義しています。`<!DOCTYPE html>`はHTML5の文書型宣言を示し、`<html>`から`</html>`までがHTML文書のルート要素です。`<head>`から`</head>`の間にはページのタイトルなどのメタ情報があり、`<body>`から`</body>`の間には実際のコンテンツが含まれます。

    6. レスポンスの送信：
        - サーバーは、生成したHTTPレスポンスをブラウザに送信します。

2. ページの表示プロセス
    1. レスポンスの受信：
        - ブラウザは、サーバーからのHTTPレスポンスを受け取ります。
    2. レスポンスの解析：
        - ブラウザは、受け取ったHTMLレスポンスを解析し、ページの構造や内容を理解します。また、HTML内に含まれる他のリソース（画像、スクリプトなど）の取得も開始します。
    3. リソースの取得：
        - ブラウザは、HTML内に含まれる画像やスクリプトなどのリソースを取得します。これらのリソースは、レスポンスに含まれるURLを元に取得されます。
    4. ページのレンダリング：
        - ブラウザは、取得したリソースを元にページのレンダリングを行います。HTMLの構造に基づいてページを組み立て、CSSを適用してデザインを整えます。
    5. 画像やスクリプトの埋め込み：
        - 取得した画像やスクリプトなどのリソースは、ページに埋め込まれます。これにより、ページには画像や動的な機能が含まれるようになります。
    6. ページの表示：
        - 最終的に、ブラウザが組み立てたページが表示され、ユーザーがコンテンツを閲覧できるようになります。

以上が、HTTPリクエストとレスポンスの具体的な流れになります。ブラウザがウェブページを表示する際には、このようなプロセスが繰り返されます。

#### ステータスコードについて

先ほど`200 OK`はサーバーからのレスポンスの状態が成功とありましたが、その他にも私たちが普段目にするものもあります。  
例えば、ページが見つからないときに表示される`404 Not Found`やサーバーに負荷がかかっている状態などに見かける`503  Service Unavailable`などがあります。  
その他にもいろいろなステータスコードがありますので、興味があれば調べてみてください。

### 4.4.2 HTTPプロトコルとWebサーバの概要

インターネットで利用できるサービスは、いろいろありますが、ここでは、特にWebサービスの構成に利用されるプロトコル、HTTPについて解説します。

一般にHTTPは、HTTPサーバー(Webサーバー)とHTTPクライアント(Webブラウザ)間で利用されます。

HTTP（HyperText Transfer Protocol）は、ウェブページやウェブサイトなどの情報をインターネット上でやり取りするためのプロトコルです。クライアントとサーバーと呼ばれる2つのコンピューター間で通信を行います。

例えば、ウェブブラウザ（クライアント）を使ってウェブページを閲覧する場合、ブラウザがウェブサーバーに対してHTTPリクエストを送信し、ウェブサーバーはそのリクエストに応じて情報を返します。このやり取りがHTTPによって行われます。

HTTPサーバーは、HTTPクライアントからテキストのリクエスト、画像のリクエスト、画像の登録等のリクエストがあるのを待機しています。一般的にTCP/IPの80番ポートが利用されます。

HTTPクライアントは、利用したいサーバーのTCP/IPの80番ポートをめがけてリクエストをします。

たとえば、Googleに接続してサービスを利用したい場合はWebブラウザのアドレス欄に、http://www.google.co.jp と入力します。

一般的にHTTPサーバとの通信は80番ポートを使うことになっているので、HTTPクライアントでポート番号を省略すると80番ポートとして動作します。

つまり、http://www.google.co.jp:80 と入力したのと同じです。

ただし80番ポートはデータ通信をする際に暗号化されないので、秘密にしたい情報のやりとりには向きません。HTTPはセキュリティの面で脆弱です。この問題を解決するために、HTTPS（HyperText Transfer Protocol Secure）が開発されました。

HTTPSは、HTTPのセキュリティを強化したバージョンです。HTTPSのSは「Secure」のSで、データが暗号化されて送受信されるため、第三者が情報を傍受することが困難になります。これにより、ユーザーの個人情報や重要なデータを安全に送信することができます。

HTTPSではSSL/TLSで保護された通信を利用します。一般的にHTTPSでの通信は443番ポートが利用されます。

こちらは、https://www.google.co.jp と入力します。https://www.google.co.jp:443 と入力したのと同じです。

ただし、実際には 

http://www.google.co.jp と入力すると、googleのHTTPサーバのポリシーによって、セキュアな接続を利用するように 

https://www.google.co.jp へリダイレクト(転送)されるサービスもあります。


HTTPサーバーはHTTPクライアントからリクエストを受け付けると、HTTPクライアントの画面に表示される文字情報、画像、音声、動画等目に見える情報(HTMLやPNG,MP4等)と、それらを配置するレイアウト情報(CSS)、HTTPクライアント側で動作するプログラム(JavaScript)等を要求のあったクライアントに向けて返信します。  

1つのサーバーが同時に複数のリクエストを受け付けても、リクエストをしたHTTPクライアントには固有のIPアドレスが割り当てられていて、そのIPアドレスも含めてリクエストするので、それぞれのHTTPクライアントのリクエストに応じた適切な内容を返信します。  

HTTPは、リクエストへの返信が完了すると、一旦、HTTPクライアントとの接続を切断します。つまり、次に同じHTTPクライアントからリクエストがあっても、以前にリクエストされたHTTPクライアントと同一なのか判断できません。  

このままでは、ショッピングサイトで、買い物をしようと商品をカートに入れても、別の商品をカートに入れる際、最初のカートの情報がわからなくなってしまい、いつまでもレジに進むことができません。  

そこで、セッション管理機能を使うことで、HTTPサーバーが最初のリクエストを受け付けた時に、HTTPクライアントに返信するデータにセッション情報を含めて、次のHTTPクライアントからのリクエストには、そのセッション情報も含めてもらうことで、別の商品をカートに入れる際も、最初のカート番号が識別できるようになります。

### 4.4.3 Webブラウザ、HTML,JavaScriptの概要

HTTPクライアントは、Webブラウザとも呼ばれます。Webブラウザの一例として、Internet Exploer, Chrome, Firefox, Safari等があります。

Webブラウザには、HTTPサーバにリクエストを送信する機能、返信された文字や画像等のコンテンツを受信して、定義されているレイアウトに応じてコンテンツを配置する機能、動画や音声を再生する機能、JavaScriptで記述されたWebブラウザ側で動作するプログラムを実行する機能、パソコンやスマートフォンのカメラやマイクを利用する機能等があります。

また、セキュアな接続が必要な場合は、その接続先が信頼できるか確認したり、暗号化した通信をする機能も含まれます。

HTML,CSS,JavaScriptを含んだコンテンツの例:
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>HTMLの例</title>
    <script>
        function hi() {
            alert("Hi!");
        }
    </script>
    <style>
        .red {
            color: #FF0000;
        }
    </style>
</head>
<body>
    <div class="red">
        <p>HTMLの例</p>
        <input type="button" value="ボタン" onclick="hi()">
    </div>
</body>
</html>
```

(a) HTML

HTMLはHyperText Markup Languageの略で、ウェブページの構造や内容を定義するための言語で、HTTPのリクエストに対する応答の本文です。

`<!DOCTYPE html>`を頭に置くことでHTML文書のバージョンを定義します。

`<body>`と`</body>`のようにタグと呼ばれる文字を利用しながらコンテンツの内容、構造を記述します。タグの中にタグを含めることができます。  
HTMLタグは以下のようなもので構成されています。  
`<html>`：HTML文書のルート要素を定義  
`<head>`：ページのメタ情報やスクリプト、スタイルシートのリンクを定義  
`<title>`：ページのタイトルを定義  
`<body>`：実際のページコンテンツを定義  
`<div>`：コンテンツをグループ化するための汎用的なコンテナ。  
`<p>`：段落を定義するためのタグ  
`<a>`：ハイパーリンクを作成するためのタグ  
`<img>`：画像を表示するためのタグ  
`<ul>`と`<li>`：順序なしリストを作成するためのタグ  
`<ol>`と`<li>`：順序付きリストを作成するためのタグ  
`<form>`：フォームを作成するためのタグ  
`<input>`：フォームの入力フィールドを作成するためのタグ  
`<button>`：クリック可能なボタンを作成するためのタグ  
`<span>`インライン要素のコンテナ  

また、タグの他に属性やコンテンツなどがあり、それらを含めて「要素」と呼ばれています。
```html
<tagname attribute="value">コンテンツ</tagname>
```

HTMLのタグはブロックレベル要素とインライン要素に分けられます。

1. ブロックレベル要素（Block-level Elements）
    - 新しい行で始まり、親要素の幅いっぱいに広がります。
    - 通常、段落、見出し、リスト、テーブル、フォームなどの要素がブロックレベルです。
    - ブロック要素は常に新しい行から始まり、新しい行で終了します。
    - 幅、高さ、マージン、パディングなどのCSSスタイルを直接指定できます。
    - 例: `<div>`, `<p>`, `<h1>` 〜 `<h6>`, `<ul>`, `<ol>`, `<li>`, `<table>`, `<form>`など。
2. インライン要素（Inline Elements）
    - ブロック要素の内部に含まれ、行内で表示されます。
    - 通常、テキストやリンク、強調、画像などの小さな要素がインラインです。
    - インライン要素は、ブロック要素の一部として配置され、同じ行に表示されます。
    - 幅と高さを直接指定できません。要素の内容に応じてサイズが決まります。
    - 例: `<span>`, `<a>`, `<strong>`, `<em>`, `<img>`, `<input>`など。

また、ブロックレベル要素とインライン要素の両方の特性を持つインラインブロック要素というのも存在します。  
`display: inline-block;`などで指定することで扱うことができます。
インラインブロック要素の特徴は以下の通りです。
- ブロック要素とインライン要素の中間に位置し、他の要素の中に配置されることができます。
- 幅と高さを直接指定できますが、デフォルトの幅は内容に合わせます。
- インラインブロック要素は、同じ行に表示されますが、他の要素との間に余白が自動的に挿入されません。
- 例: `<div>`要素にdisplay: inline-block;スタイルを適用した場合。

これらの要素を組み合わせて、柔軟で効果的なレイアウトを作成できます。ブロック要素はセクションの構造を定義し、インライン要素はテキストや小さな要素を制御し、インラインブロック要素はその両方の特性を組み合わせた柔軟なレイアウトを実現します。

(b) CSS

 CSSはCascading Style Sheetsの略で、主にコンテンツの装飾を担います。

上記の例では`<style>`タグに記述していますが、別のファイルに記述することが多いです。

コンテンツの装飾はわざわざCSSに分けなくても記述できますが、コンテンツ本体と装飾が混在した状態では記述内容が分かりにくいこと、HTMLに含まれるコンテンツの再利用がしづらいこと等の理由から、現在は分割するスタイルが主流です。

```html
<head>
    <link rel="stylesheet" href="styles.css">
</head>
```

スタイルを適用する要素を選択することをセレクタと呼びます。  
`セレクタ{プロパティ: 値;}`と書きます。
```css
selector {
    property: value;
}
```

主なCSSプロパティは以下の通りです。  
`color`：テキストの色を指定します。  
`font-size`：テキストのサイズを指定します。  
`background-color`：背景色を指定します。  
`margin`, `padding`：要素の余白を指定します。  
`border`：要素の境界線を指定します。  

(c) JavaScript

JavaScriptはWebブラウザ側で動作させることができるプログラム言語です。ユーザーの操作やイベントに応答して動的な振る舞いを実装します。

上記の例では`<script>`タグにプログラムを記述し、ボタンをクリックしたらJavaScriptのプログラムを実行しています。

JavaScriptの機能には以下のようなものがあります。
- イベント処理：ユーザーの操作に応答して動作します。
- DOM操作：ページの要素を追加、変更、削除します。
- データ処理：データを操作し、計算します。
- アニメーション：要素を動かしたり、アニメーション効果を追加します。

JavaScriptは、変数も使用できますし、functionで様々なメソッド(処理のかたまり)を作成して、WebブラウザからHTTPサーバーへ送信するリクエストの内容を確認したり、入力するデータの補助機能を記述したり、音や画像を使ったゲームを記述することもできます。

```js
// ユーザーの名前を保持する変数
var userName;

// リクエストを送信する関数
function sendRequest() {
    // ユーザーが入力した名前を取得
    userName = document.getElementById("name").value;

    // HTTPリクエストを送信（ここでは単純にコンソールに出力するだけ）
    console.log("サーバーへのリクエスト：こんにちは、" + userName + "さん！");
}
```

#### まとめ
HTMLはウェブページの構造を定義し、CSSは見栄えを整え、JavaScriptは動作を追加してインタラクティブな体験を提供します。これらの言語を組み合わせて、魅力的で機能的なウェブサイトやアプリケーションを開発することができます。


#### 練習
```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECサイトのサンプル</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            line-height: 1.6;
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 0 20px;
        }

        header {
            background: #333;
            color: #fff;
            padding: 10px 0;
        }

        header nav ul {
            list-style: none;
        }

        header nav ul li {
            display: inline;
            margin-right: 20px;
        }

        header nav ul li a {
            color: #fff;
            text-decoration: none;
        }

        main {
            padding: 20px 0;
        }

        .product {
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
        }

        .product img {
            width: 100%;
            height: auto;
        }

        footer {
            background: #333;
            color: #fff;
            text-align: center;
            padding: 20px 0;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ECサイトのサンプル</h1>
            <nav>
                <ul>
                    <li><a href="#">ホーム</a></li>
                    <li><a href="#">商品一覧</a></li>
                    <li><a href="#">マイページ</a></li>
                    <li><a href="#">カート</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <section id="products">
            <h2>人気商品</h2>
            <div class="product">
                <img src="product1.jpg" alt="商品1">
                <h3>商品名1</h3>
                <p>価格: 1000円</p>
                <button onclick="addToCart(1)">カートに追加</button>
            </div>
            <div class="product">
                <img src="product2.jpg" alt="商品2">
                <h3>商品名2</h3>
                <p>価格: 1500円</p>
                <button onclick="addToCart(2)">カートに追加</button>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 ECサイトのサンプル</p>
        </div>
    </footer>

    <script>
        function addToCart(productId) {
            // 仮のカートへ商品を追加する処理
            alert("商品をカートに追加しました！");
        }
    </script>
</body>
</html>
```

上記のCSSやJavaScriptは埋め込まれています。別ファイルに移動して表示してみましょう。
また、HTMLのタグを追加したりCSSで文字の色などを変えたりしてHTMLやCSS、JavaScriptに触れてみましょう。    
    
ヒント：

 - HTML内にCSS、JavaScriptを反映させる記述が必要です。
 - 反映させる際、ファイルの位置に気を付けて記述しましょう。
