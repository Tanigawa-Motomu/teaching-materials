## Ruby on Rails：ECサイト　問題

 ### 作成アプリ：本を取り扱うECサイト  

 管理者側とユーザー側がそれぞれ別の画面を見るように作成しましょう。  
 作成するアプリ名は`ec_site`としてください。
 

 ### 要件  
 
 1. 管理者側  
    + ログインしていない場合はログイン画面は管理者側、ユーザー側同一のものを使用してください。  
    + メールアドレス、パスワードを元に管理者側かユーザー側かを判定する処理を実装してください。  
    + 未登録の場合、新規で登録できるようにしてください。  
    + 商品の登録、詳細、更新、削除ができるようにしてください。また、商品の画像をアップロードできるようにしてください。  
    + 管理者のログイン認証ができるよう実装してください。  
    + 全体の注文が確認できるようにしてください。  

 1. ユーザー側  
    + 商品の一覧、各商品の詳細が確認できるようにしてください。    
    + 商品の注文ができるようにしてください。  
    + カートに入れている商品を削除できるようにしてください。  
    + 注文完了後にメールが送信できるようにしてください。  
    + 商品が検索できるようにしてください。  
    + マイページからログアウトできるようにしてください。  

### 実装機能
下記に実装要件を提示する。

__【会員側実装機能】__
+ 顧客は会員登録、ログイン・ログアウトができること
+ 会員のログインはメールアドレスとパスワードで行うこと
+ 会員がログインしている状態かどうか、ページのヘッダーにユーザ名を表示するなどして判断できるようにすること
+ サイトの閲覧はログインなしで行えないこと
+ 書籍をカートに入れ、1度に複数書籍の購入ができること。また、カート内の書籍は個数変更・削除ができること
+ 会員はマイページから下記が行えること
   + ユーザ情報の閲覧・編集
   + 注文履歴の閲覧
+ 注文履歴一覧には下記の情報が表示されること
   + 注文日
   + 支払金額
+ 注文履歴詳細には下記の情報が表示されること
   + 注文日
   + 商品の注文内容詳細（商品名、単価、個数、小計）
   + 請求情報（支払金額）
+ 会員登録時、下記の情報をユーザ情報として入力できること
   + メールアドレス
   + パスワード
+ ヘッダには検索窓を配置し、検索できる
+ ジャンルごとに商品が表示できる

<br>

__【管理者側実装機能】__
+ 管理者用メールアドレスとパスワードでログインできること
（管理者用メールアドレスとパスワードは事前にSeed等でデータベースへ登録しておく）
+ 書籍について、下記が行えること
   + 新規追加、編集、閲覧
+ 書籍情報は下記のものを持つこと
   + 書籍名
   + 著者名
   + 発行日
   + タグ
   + 価格
   + 販売ステータス
+ 会員登録されているユーザ情報の閲覧が行えること
+ ユーザの注文履歴が一覧・詳細表示でき、下記の情報が表示されること
   + 注文履歴一覧
     + 購入日時
     + 購入者
     + 注文個数
   + 注文履歴詳細
     + 購入者
     + 注文日
     + 請求金額
     + 各注文書籍詳細（書籍名、単価、数量、小計）
+ ヘッダには検索窓を配置し、検索できる
+ ジャンルごとに商品が表示できる



 ### 実装機能一覧  
 
 __【ユーザー】__
 | No | 機能 | 機能内容 | 非ログイン時使用可否 |
 |:---:|:---|:---|:---:|
 | 1 | ログイン | メールアドレス、パスワードでログインできる。<br>ログイン時のみ利用できる機能が利用できるようになる。 | 〇 |
 | 2 | ログアウト | ログインしている状態からログアウト状態にする。<br>ログイン時のみ利用できる機能が利用できなくなる。 | × |
 | 3 | 書籍一覧表示 | 書籍を一覧表示する。<br>検索結果を表示する場合は、検索条件にあてはまる商品のみ一覧表示する。 | × |
 | 4 | 書籍詳細表示 | 書籍一覧画面で選択した書籍の詳細情報を表示する。<br>カート追加機能が表示されている。 | × |
 | 5 | カート追加 | カートに書籍を追加することができる。 | × |
 | 6 | カート一覧 | カートの中を一覧表示することができる。 | × |
 | 7 | カート編集 | カートの中を編集、削除することができる。| × |
 | 8 | 注文 | カートの中を注文することができる。 | × |
 | 9 | 注文完了メール送信 | 注文が完了した後にメールを送信できる。 | × |
 | 10 | 注文履歴一覧表示 | 過去の注文を一覧で確認できる。 | × |
 | 11 | 注文履歴詳細表示 | 注文の詳細を確認できる。 | × |

 <br>

 __【管理者】__
 | No | 機能 | 機能内容 | 非ログイン時使用可否 |
 |:---:|:---|:---|:---:|
 | 1 | ログイン | メールアドレス、パスワードでログインできる。<br>ログイン時のみ利用できる機能が利用できるようになる。 | 〇 |
 | 2 | ログアウト | ログインしている状態からログアウト状態にする。<br>ログイン時のみ利用できる機能が利用できなくなる。 | × |
 | 3 | 書籍一覧表示 | 書籍を一覧表示する。<br>検索結果を表示する場合は、検索条件にあてはまる商品のみ一覧表示する。 | × |
 | 4 | 書籍詳細表示 | 書籍一覧画面で選択した書籍の詳細情報を表示する。<br>カート追加機能が表示されている。 | × |
 | 5 | 書籍情報編集 | 書籍の登録、更新、削除ができる。 | × |
 | 6 | タグ情報編集 | タグの登録、更新、削除ができる。 | × |



### (1) ECサイトにタイムゾーンを設定しましょう。

<br>

### (2) 商品タグ(Tag)の登録と編集のあと、直接一覧ページへ遷移するように変更しましょう。また、不要になった詳細ページに関連するものは全て削除しましょう。

__【ヒント】__  
 - ルーティングは詳細ページを対象外とするよう修正する必要があります。
 - コントローラーはテストも含めて修正が必要です。
 - タグの一覧画面に詳細ページの一部機能を追加する必要があります。

<br>

### (3) 新たにアプリを作成して、投稿機能を実装してください。  
作成時には以下の条件で実装してください。  
- アプリ名は`article_practice`で作成してください。
- データベースに保存されるカラムは`タイトル`と`投稿内容`の2種類を実装してください。
- `rails g model`を使って作成してください。
- 投稿一覧ページ、投稿詳細ページ、新規投稿ページ、投稿編集ページを実装してください。
- 投稿一覧ページに投稿詳細ページへのリンクを実装してください。その際、タイトルをクリックすると該当の投稿詳細ページへ遷移するように実装してください。
- 投稿詳細ページには投稿編集ページへのリンク、一覧ページへのリンク、削除ボタンを実装してください
- 削除ボタンは`button_to`メソッドで実装してください。
- 新規投稿、投稿編集を行った際は投稿一覧画面でメッセージを緑色で表示してください。
- 削除を行った際は投稿一覧画面でメッセージを赤色で表示してください。
- 今回レイアウト調整を行う際は`/app/assets/stylesheets/application.css`に記述してください。class名は規定はありませんが、内容を把握しやすいclass名にしてください。

<br>

### (4) 以下の図のように、Taggingデータの設定を追加しましょう。

![画像](images/08-3-3-1.png)

<br>

### (5) 新たにアプリを作成してバリデーションを追加しましょう。そのとき、通常のバリデーションとカスタムバリデーションを両方使用してください。

ヒント：
 - 作成に迷う人は身長と体重に対するバリデーションを考えてみましょう。
 - 遊園地のアトラクションの条件を参考に設定してみるのもいいかもしれません。

例：身長体重の一覧表

ターミナル
```sh
rails new people_lists
```

`Member : 人物テーブル`
| field名 | 名 称 | 型 | バリデーション |
|---|---|---|---|
| id | ID | integer |  |
| name | 名前 | string | is not null、1文字以上20文字以内、ユニーク |
| height | 身長 | float | is not null、1以上の入力が必要 |
| weight | 体重 | float | is not null、1以上の入力が必要 |

`height`と`weight`のエラーメッセージはカスタムメッセージで設定しましょう。練習した問題を元に考えてみましょう。

<br>

### (6) 新しくアプリを作成して`bcrypt`を使ってユーザー認証を行ってください。  

作成の際は以下の条件を元に行ってください。
- Userモデルの作成
- サインアップ画面、ログイン画面、ログアウトボタンの実装
- サインアップ、ログイン後はmy_pageへ遷移する
- top画面、my_page画面の作成(モデル不要)
- ログインしているユーザーのみmy_page画面へ遷移できる
- ログアウト後はtop画面へ遷移する
- ログインしていないユーザーはtop画面へ遷移する
- my_pageにはログインしているユーザーの名前を表示する

__【ヒント】__  
- sessions_controllerのcreate実装
```rb
# app/controllers/sessions_controller.rb

def create
  user = User.find_by(email: emailのパラメーター)
  if user && user.authenticate(パスワードのパラメーター)
    session[:user_id] = user.id
    redirect_to マイページパス
  else
    render 
  end
end
```

- ログインしているかどうかを判定
```rb
# app/controllers/homes_controller.rb

before_action :require_login, only: [:my_page]
・
・
def my_page
end

private

def require_login
  if ログインしているかどうか？
    redirect_to login_path
  end
end
```

<br>

### (7) 新しくアプリを作成しましょう。その際、`Devise`を使ってユーザー認証をしましょう。  

作成の際は以下の通りに行ってください。  
- `Devise`を使って`User`モデルを作成する
- `User`モデル作成時に`email`、`password`のほかにユーザー名(`name`カラム)も追加する
- ログイン時は`email`ではなく`name`カラムと`password`を参照してログインする
- top画面、my_page画面の作成(モデル不要)
- サインアップ、ログイン後はmy_pageへ遷移する
- ログインしているユーザーのみmy_page画面へ遷移できる
- ログアウト後はtop画面へ遷移する
- ログインしていないユーザーはtop画面へ遷移する
- my_pageにはログインしているユーザーの名前を表示する
  
__【ヒント】__  
- config/initializers/devise.rbを変更する
- app/controllers/users/sessions_controller.rbを変更する

<br>

### (8) `ec_site` に商品一覧に認証を追加してみましょう。また、新たにユーザーのCRUD機能を作成し、認証を追加しましょう。  

__【ヒント】__  
 - ユーザーはgem`devise`を使用して機能を実装してください。
 - マイページが見れるようにする必要があります。
 - 編集、削除はまだ考えなくても大丈夫です。
 - ログアウトボタンはマイページにある想定です。
 - ユーザー認証のためにはコントローラーにあることが必要になります。

 <br>

### (9) 新しく`photo_post`アプリを以下の条件で作成してください。
作成の際は以下の条件で行ってください。  
- `User`モデルと`Post`モデルを実装してください。
- `User`モデルでは名前(20文字以内)、アイコン画像を設定できます。
- `Post`モデルではタイトル(20文字以内)、投稿内容(200文字以内)、画像の投稿ができます。
- ユーザーを新規作成するときはアイコンを設定できます。
- ユーザーはログイン後にマイページへ遷移します。
- ユーザーはマイページでは以下画面へ遷移するボタンもしくはボタンがあります。
    - 投稿一覧画面
    - ユーザー編集画面
    - ログアウトボタン
- ユーザー編集画面では以下の変更ができます。
    - 名前の変更
    - アイコンの変更
- 新規投稿ページはタイトル、投稿内容、画像が入力できます。(今回はユーザーと投稿を紐づける必要はありません)
- 新規投稿後は投稿一覧ページへ遷移します。
- 一覧ページの画像のサイズは300x300にしてください。
- 一覧ページから投稿のタイトルを押下すると該当の投稿詳細ページへ遷移します。
- 詳細ページの画像のサイズは600x600にしてください。

<br>

#### (10) `ec_site` に注文機能を実装しましょう。

まずは、以下のコントローラを作成しましょう。

- productsコントローラ：管理者以外のユーザが閲覧するページ
- ordersコントローラ：注文処理を実装するコントローラ

また、注文情報を保存するためのOrderモデルを作成しましょう。

`Orderモデル`

|field名|名称|型|
|:--|:--|:--|
|id|ID|integer|
|book_id|商品ID|integer|
|count|個数|integer|
|address|届け先|text|

#### 実装の流れ

- 利用者が見る商品一覧画面と詳細画面を作成
- 商品詳細画面に注文ボタンを作成
- 注文ボタンをクリックすると、個数、届け先の入力フォーム、次へ進むのボタンを表示
- 次へ進むをクリックすると、注文した商品、入力した内容、注文確定ボタンを表示
- 注文確定ボタンをクリックすると、注文データの作成し、注文完了画面を表示



<br>

### (11) `ec_site` に商品の注文ステータスを管理するモデルを作成し、`enum`で状態遷移を実装してみましょう。

<br>

### (12) 以下のアプリを作成してください。
以下の条件で投稿型SNSを作成してください。
- `User`モデルと`Post`モデルを実装して両者が紐づくようにしてください。
- `User`モデルには以下の項目が登録できます。可能なものは`enum`を使ってください。
  - 名前
  - 生年月日
  - 性別(男性、女性、その他)
  - 血液型(A型、B型、O型、AB型、わからない)
  - 自己紹介文
- `Post`モデルでは以下の項目が登録できます。可能なものは`enum`を使ってください。
  - 投稿内容
  - ステータス(下書き、公開、非公開)
- ステータスの状態で一覧に表示するものを変更してください。
  - 下書き：表示しない
  - 公開：表示する
  - 非公開：表示しない
- ステータスの状態によって編集できる項目を変更してください。
  - 下書き：投稿内容、ステータス変更可能
  - 公開：ステータスのみ変更可能
  - 非公開：ステータスのみ変更可能
- ステータスの変更は`!`メソッドを使って変更してください。

<br>

### (13) `ec_site` にカート(買い物かご)の機能を実装していきます。セッションIDを管理するテーブルとしてCartテーブルとカート内の商品明細を管理するLineItemテーブルを用意しましょう。

CartモデルとLineItemモデルの関係性は下の図のようになります。LineItemテーブルのquantityは、購入個数（integer）を表します。

![画像](images/12-2-1-2.png)

実装方法がイメージできない場合は、以下のステップを参考に実装してみてください。

#### ステップ-1) セッション管理テーブルの準備
- Cartテーブルの追加
- LineItemテーブルの追加（個数については、初期値を設定）
- 追加したモデルの関連付けを設定

#### ステップ-2) セッション登録機能の追加
- ApplicationControllerにcurrent_cartを実装

#### ステップ-3) カート登録機能の追加
- Cartモデルに商品を登録するadd_productを実装
- LineItemsコントローラのcreateメソッドで、セッションからカート情報を取得し、Cart#add_productを利用してカートに注文明細を登録
- 商品詳細画面の「購入する」ボタンを「買い物かごに入れる」ボタンにしてリクエストをline_items#createに変更

#### ステップ-4) カート（買い物かご）一覧画面の編集
- LineItemモデルにbookごとの小計金額を表示するためのtotal_priceを実装
- Cartモデルにカート合計金額を表示するためのtotal_price、合計個数を表示するためのtotal_numberを実装
- LineItem#total_price, Cart#total_price,total_numberを利用してカート一覧画面（carts#show）を編集

#### ステップ-5) カート削除機能の追加
- Cartsコントローラにセッションを削除できるようにdestroyメソッドを実装
- カート一覧画面に「買い物かごを空にする」ボタンを追加

<br>

### (14) `ec_site` でユーザーがカートに入った複数商品を一括購入できる機能を実装しましょう。カートはセッションを参照していますので、それらを注文(Order)テーブルに置き換える必要があります。

Orderモデルはすでにあるものを利用します。新しく追加するOrderDetailモデルとの関係性は下の図のとおりです。

![画像](images/12-3-1-1.png)

実装方法がイメージできない場合は、以下のステップを参考に実装してみてください。

#### ステップ-1) 複数明細の購入処理テーブルの準備
- 一括で購入登録ができるように、OrderDetailモデルに個数管理を行うカラム（integer、初期値0）を追加

#### ステップ-2) 複数明細の一括購入処理への変更
- Ordersコントローラのnew,confirm,createメソッドで単一購入から複数購入できるように変更
- カート一覧画面に「購入する」ボタンを追加してリクエストをorders#newにする
- Orderモデルに合計金額を表示するためのtotal_price、合計個数を表示するためのtotal_numberを実装
- OrderDetailモデルに商品の小計金額を表示するためのtotal_priceを実装
- 購入登録画面（orders#new）で複数の商品の情報が扱えるように修正

<br>

### (15) 投稿型SNSを作成して、お気に入り機能を実装してみましょう。
以下の条件でアプリを完成させてください。
- 基本として`User`モデルと`Post`モデルを実装してください。
- `User`モデルにはユーザー名とメールアドレス、パスワード、自己紹介文を登録できるようにしてください。
- `Post`モデルには投稿内容を登録できるようにしてください。(余力があれば画像も)
- 投稿に対してお気に入りができるようにモデルを実装してください。
- お気に入りは以下の通りです。
  - ☆：お気に入りではない
  - ★：お気に入り
  - 初期状態：☆
  - ☆を押下後に★に切り替わること
  - ★を押下後に☆に切り替わること

<br>

### (16) 投稿アプリを作成しましょう。以下の条件で作成してください。
- `User`モデルと`Post`モデルを作成してください。
- `User`モデルにはユーザー名とメールアドレス、パスワードを設定しログインできるようにしてください。その他は自由です。
- `Post`モデルではタイトル、内容を登録できるようにしてください。
- `User`モデルと`Post`モデルを検索できるようにしましょう。

余裕があれば完全一致で検索する方法などのオプションも調べてみてください。
また、投稿機能にタグをつけられるようにして、検索機能を付けてみましょう。

<br>

### (17) 新たに書籍管理アプリを作成して、gemを使わないで検索を実装しましょう。以下の条件で作成してください。
- `User`モデルと`Book`モデル、`Tag`モデルを作成してください。
- `User`モデルにはメールアドレスとパスワードを設定しログインできるようにしてください。その他は自由です。
- `Book`モデルではタイトル、内容、タグ、価格を登録できるようにしてください。
- `Tag`モデルではタグ名を登録できるようにしてください。
- `Book`と`Tag`は多対多の関係です。
- 検索できる条件は以下の通りです。
  - 書籍
    - タイトル：部分一致検索
    - 内容：部分一致検索
    - 価格：完全一致検索
  - タグ
    - タグ名：完全一致検索
- 入力なしの場合は全項目が表示される

余裕があれば以下の条件も付け足してみてください。
- 書籍
  - タイトル：部分一致と完全一致を選択できるようにする
  - 内容：部分一致と完全一致を選択できるようにする
  - 価格：以上、以下を選択できるようにする
- タグ
  - タグ名：書籍詳細ページや一覧ページにタグのボタンを配置して押下すると検索できるようにする

<br>

### (18) 以下の条件でおすすめ書籍共有アプリを作成してください。
- `User`モデルと`Book`モデル、`Mailer`を実装してください。
- `Book`モデルではタイトル、書籍内容が登録できます。
- ユーザーは書籍一覧からおすすめしたい書籍の詳細を見ることができます。
- 書籍詳細ページでは共有ボタンを押下し、メール作成ページへ押下します。メール作成ページでは以下が存在します。
  - 入力フォーム
  - 確認ボタン
- 共有ボタン押下後は送信入力ページに遷移します。入力ページでは下記の内容が入力できます。
  - 送信先
  - タイトル
  - 本文
- 件名は以下のように設定します。
  - 「`ログイン中のユーザー名`よりおすすめの書籍をご紹介します」
- 確認ボタン押下後プレビュー画面へ遷移します。プレビュー画面にはプレビューの他に送信ボタンがあります。
- 送信ボタン押下後にメールを送信します。

<br>

### (19) `ec_site` に商品の購入後にメールを送信する機能を実装してみましょう。