## Ruby on Rails：ECサイト　問題

 ### 作成アプリ：本を取り扱うECサイト  

 管理者側とユーザー側がそれぞれ別の画面を見るように作成しましょう。  
 作成するアプリ名は`ec_site`としてください。
 

 ### 要件  
 
 1. 管理者側  
    + ログインしていない場合はログイン画面は管理者側、ユーザー側同一のものを使用してください。  
    + メールアドレス、パスワードを元に管理者側かユーザー側かを判定する処理を実装してください。  
    + 未登録の場合、新規で登録できるようにしてください。  
    + 商品の登録、詳細、更新、削除ができるようにしてください。また、商品の画像をアップロードできるようにしてください。  
    + 管理者のログイン認証ができるよう実装してください。  
    + 全体の注文が確認できるようにしてください。  

 1. ユーザー側  
    + 商品の一覧、各商品の詳細が確認できるようにしてください。    
    + 商品の注文ができるようにしてください。  
    + カートに入れている商品を削除できるようにしてください。  
    + 注文完了後にメールが送信できるようにしてください。  
    + 商品が検索できるようにしてください。  
    + マイページからログアウトできるようにしてください。  

### 実装機能
下記に実装要件を提示する。

__【会員側実装機能】__
+ 顧客は会員登録、ログイン・ログアウトができること
+ 会員のログインはメールアドレスとパスワードで行うこと
+ 会員がログインしている状態かどうか、ページのヘッダーにユーザ名を表示するなどして判断できるようにすること
+ サイトの閲覧はログインなしで行えないこと
+ 書籍をカートに入れ、1度に複数書籍の購入ができること。また、カート内の書籍は個数変更・削除ができること
+ 会員はマイページから下記が行えること
   + ユーザ情報の閲覧・編集
   + 注文履歴の閲覧
+ 注文履歴一覧には下記の情報が表示されること
   + 注文日
   + 支払金額
+ 注文履歴詳細には下記の情報が表示されること
   + 注文日
   + 商品の注文内容詳細（商品名、単価、個数、小計）
   + 請求情報（支払金額）
+ 会員登録時、下記の情報をユーザ情報として入力できること
   + メールアドレス
   + パスワード
+ ヘッダには検索窓を配置し、検索できる
+ ジャンルごとに商品が表示できる

<br>

__【管理者側実装機能】__
+ 管理者用メールアドレスとパスワードでログインできること
（管理者用メールアドレスとパスワードは事前にSeed等でデータベースへ登録しておく）
+ 書籍について、下記が行えること
   + 新規追加、編集、閲覧
+ 書籍情報は下記のものを持つこと
   + 書籍名
   + 著者名
   + 発行日
   + タグ
   + 価格
   + 販売ステータス
+ 会員登録されているユーザ情報の閲覧が行えること
+ ユーザの注文履歴が一覧・詳細表示でき、下記の情報が表示されること
   + 注文履歴一覧
     + 購入日時
     + 購入者
     + 注文個数
   + 注文履歴詳細
     + 購入者
     + 注文日
     + 請求金額
     + 各注文書籍詳細（書籍名、単価、数量、小計）
+ ヘッダには検索窓を配置し、検索できる
+ ジャンルごとに商品が表示できる



 ### 実装機能一覧  
 
 __【ユーザー】__
 | No | 機能 | 機能内容 | 非ログイン時使用可否 |
 |:---:|:---|:---|:---:|
 | 1 | ログイン | メールアドレス、パスワードでログインできる。<br>ログイン時のみ利用できる機能が利用できるようになる。 | 〇 |
 | 2 | ログアウト | ログインしている状態からログアウト状態にする。<br>ログイン時のみ利用できる機能が利用できなくなる。 | × |
 | 3 | 書籍一覧表示 | 書籍を一覧表示する。<br>検索結果を表示する場合は、検索条件にあてはまる商品のみ一覧表示する。 | × |
 | 4 | 書籍詳細表示 | 書籍一覧画面で選択した書籍の詳細情報を表示する。<br>カート追加機能が表示されている。 | × |
 | 5 | カート追加 | カートに書籍を追加することができる。 | × |
 | 6 | カート一覧 | カートの中を一覧表示することができる。 | × |
 | 7 | カート編集 | カートの中を編集、削除することができる。| × |
 | 8 | 注文 | カートの中を注文することができる。 | × |
 | 9 | 注文完了メール送信 | 注文が完了した後にメールを送信できる。 | × |
 | 10 | 注文履歴一覧表示 | 過去の注文を一覧で確認できる。 | × |
 | 11 | 注文履歴詳細表示 | 注文の詳細を確認できる。 | × |

 <br>

 __【管理者】__
 | No | 機能 | 機能内容 | 非ログイン時使用可否 |
 |:---:|:---|:---|:---:|
 | 1 | ログイン | メールアドレス、パスワードでログインできる。<br>ログイン時のみ利用できる機能が利用できるようになる。 | 〇 |
 | 2 | ログアウト | ログインしている状態からログアウト状態にする。<br>ログイン時のみ利用できる機能が利用できなくなる。 | × |
 | 3 | 書籍一覧表示 | 書籍を一覧表示する。<br>検索結果を表示する場合は、検索条件にあてはまる商品のみ一覧表示する。 | × |
 | 4 | 書籍詳細表示 | 書籍一覧画面で選択した書籍の詳細情報を表示する。<br>カート追加機能が表示されている。 | × |
 | 5 | 書籍情報編集 | 書籍の登録、更新、削除ができる。 | × |
 | 6 | タグ情報編集 | タグの登録、更新、削除ができる。 | × |



### (1) ECサイトにタイムゾーンを設定しましょう。

<br>

### (2) 商品タグ(Tag)の登録と編集のあと、直接一覧ページへ遷移するように変更しましょう。また、不要になった詳細ページに関連するものは全て削除しましょう。

__【ヒント】__  
 - ルーティングは詳細ページを対象外とするよう修正する必要があります。
 - コントローラーはテストも含めて修正が必要です。
 - タグの一覧画面に詳細ページの一部機能を追加する必要があります。

<br>

### (4) 以下の図のように、Taggingデータの設定を追加しましょう。

![画像](images/08-3-3-1.png)

<br>

### (8) `ec_site` に商品一覧に認証を追加してみましょう。また、新たにユーザーのCRUD機能を作成し、認証を追加しましょう。  

__【ヒント】__  
 - ユーザーはgem`devise`を使用して機能を実装してください。
 - マイページが見れるようにする必要があります。
 - 編集、削除はまだ考えなくても大丈夫です。
 - ログアウトボタンはマイページにある想定です。
 - ユーザー認証のためにはコントローラーにあることが必要になります。

 <br>

#### (10) `ec_site` に注文機能を実装しましょう。

まずは、以下のコントローラを作成しましょう。

- productsコントローラ：管理者以外のユーザが閲覧するページ
- ordersコントローラ：注文処理を実装するコントローラ

また、注文情報を保存するためのOrderモデルを作成しましょう。

`Orderモデル`

|field名|名称|型|
|:--|:--|:--|
|id|ID|integer|
|book_id|商品ID|integer|
|count|個数|integer|
|address|届け先|text|

#### 実装の流れ

- 利用者が見る商品一覧画面と詳細画面を作成
- 商品詳細画面に注文ボタンを作成
- 注文ボタンをクリックすると、個数、届け先の入力フォーム、次へ進むのボタンを表示
- 次へ進むをクリックすると、注文した商品、入力した内容、注文確定ボタンを表示
- 注文確定ボタンをクリックすると、注文データの作成し、注文完了画面を表示



<br>

### (11) `ec_site` に商品の注文ステータスを管理するモデルを作成し、`enum`で状態遷移を実装してみましょう。

<br>

### (12) 以下のアプリを作成してください。
以下の条件で投稿型SNSを作成してください。
- `User`モデルと`Post`モデルを実装して両者が紐づくようにしてください。
- `User`モデルには以下の項目が登録できます。可能なものは`enum`を使ってください。
  - 名前
  - 生年月日
  - 性別(男性、女性、その他)
  - 血液型(A型、B型、O型、AB型、わからない)
  - 自己紹介文
- `Post`モデルでは以下の項目が登録できます。可能なものは`enum`を使ってください。
  - 投稿内容
  - ステータス(下書き、公開、非公開)
- ステータスの状態で一覧に表示するものを変更してください。
  - 下書き：表示しない
  - 公開：表示する
  - 非公開：表示しない
- ステータスの状態によって編集できる項目を変更してください。
  - 下書き：投稿内容、ステータス変更可能
  - 公開：ステータスのみ変更可能
  - 非公開：ステータスのみ変更可能
- ステータスの変更は`!`メソッドを使って変更してください。

<br>

### (13) `ec_site` にカート(買い物かご)の機能を実装していきます。セッションIDを管理するテーブルとしてCartテーブルとカート内の商品明細を管理するLineItemテーブルを用意しましょう。

CartモデルとLineItemモデルの関係性は下の図のようになります。LineItemテーブルのquantityは、購入個数（integer）を表します。

![画像](images/12-2-1-2.png)

実装方法がイメージできない場合は、以下のステップを参考に実装してみてください。

#### ステップ-1) セッション管理テーブルの準備
- Cartテーブルの追加
- LineItemテーブルの追加（個数については、初期値を設定）
- 追加したモデルの関連付けを設定

#### ステップ-2) セッション登録機能の追加
- ApplicationControllerにcurrent_cartを実装

#### ステップ-3) カート登録機能の追加
- Cartモデルに商品を登録するadd_productを実装
- LineItemsコントローラのcreateメソッドで、セッションからカート情報を取得し、Cart#add_productを利用してカートに注文明細を登録
- 商品詳細画面の「購入する」ボタンを「買い物かごに入れる」ボタンにしてリクエストをline_items#createに変更

#### ステップ-4) カート（買い物かご）一覧画面の編集
- LineItemモデルにbookごとの小計金額を表示するためのtotal_priceを実装
- Cartモデルにカート合計金額を表示するためのtotal_price、合計個数を表示するためのtotal_numberを実装
- LineItem#total_price, Cart#total_price,total_numberを利用してカート一覧画面（carts#show）を編集

#### ステップ-5) カート削除機能の追加
- Cartsコントローラにセッションを削除できるようにdestroyメソッドを実装
- カート一覧画面に「買い物かごを空にする」ボタンを追加

<br>

### (14) `ec_site` でユーザーがカートに入った複数商品を一括購入できる機能を実装しましょう。カートはセッションを参照していますので、それらを注文(Order)テーブルに置き換える必要があります。

Orderモデルはすでにあるものを利用します。新しく追加するOrderDetailモデルとの関係性は下の図のとおりです。

![画像](images/12-3-1-1.png)

実装方法がイメージできない場合は、以下のステップを参考に実装してみてください。

#### ステップ-1) 複数明細の購入処理テーブルの準備
- 一括で購入登録ができるように、OrderDetailモデルに個数管理を行うカラム（integer、初期値0）を追加

#### ステップ-2) 複数明細の一括購入処理への変更
- Ordersコントローラのnew,confirm,createメソッドで単一購入から複数購入できるように変更
- カート一覧画面に「購入する」ボタンを追加してリクエストをorders#newにする
- Orderモデルに合計金額を表示するためのtotal_price、合計個数を表示するためのtotal_numberを実装
- OrderDetailモデルに商品の小計金額を表示するためのtotal_priceを実装
- 購入登録画面（orders#new）で複数の商品の情報が扱えるように修正


<br>


### (19) `ec_site` に商品の購入後にメールを送信する機能を実装してみましょう。