# 4.9 ハッカソン（リファクタリング）

## 4.9.1 リファクタリングをしよう

開発は順調に進んでいるでしょうか？

ソフトウェアが成長するにつれて、その内部にはひずみが生まれます。想定していなかった変更によって設計が崩れ、さらなる設計の崩れを引き起こします。これは「技術的負債（technical debt）」と呼ばれるものの一種で、開発の障害となります。

開発速度を維持するため、外から見た動作はそのままに保ちながら、コードを整頓してみましょう。これがリファクタリングです。

## 4.9.2 ポイント

### 最初は簡単な修正から

まずは以下のように変更量の少ない簡単な修正から手をつけるのが安全です。その過程でコードの構造への理解も深まり、さらに大きなリファクタリングの足がかりになります。

- 名前を修正する: 開発しているうちに名前と実態がずれてしまったクラス・メソッド・変数はありませんか？　もし思い当たるものがあれば修正してみましょう。
- 重複した処理をまとめる: Viewに同じような処理が頻出していたら、Modelクラスのメソッドにしたり、`app/helpers`以下のヘルパーにできないか考えてみましょう。
- 長くなったコードを分割する

コードベースが小さく開発者が入れ替わることがない場合にはこれだけで開発速度が維持できることも多いでしょう。

### RuboCopの警告に注意

RuboCopの警告はリファクタリングするべき箇所を見つけるための便利な道しるべになります。

特にメトリクスに関わるルール（`RuboCop::Cop::Metrics`）は、複雑に入り組んだコードを検出するのに有用です。

### テストはありますか？

リファクタリングの前後でコードの挙動が変わっていないか確かめるためには、テストが欠かせません。リファクタリングの前にテストコードを見直して、不安なところがあればテストを追加しておくといいでしょう。

### 継続的インテグレーションを体感しよう

CircleCIのおかげで、GitHubに変更をプッシュするたびに自動テストが実行されるようになっているはずです。リファクタリングで既存の機能が壊れていないことを確かめるのに大変便利ですから、ぜひ活用してください。

## 4.9.3 アドバイス

### `ActiveSupport::Concern`を活用しよう

Railsでは、Rubyのミックスイン機能をより簡潔なコードで利用するために`ActiveSupport::Concern`というモジュールが用意されています。肥大化したModelクラスを整理するときなどに威力を発揮します。

### やりすぎは禁物

RubyやRailsには多彩な機能があります。ともすれば、いろいろな機能を駆使して可読性の低いコードを書いてしまいがちですが、リファクタリングの目的はコードベースをシンプルにすることです。過度の抽象化は避けましょう。
